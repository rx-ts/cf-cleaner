<div class="confluence-information-macro has-no-icon confluence-information-macro-tip conf-macro output-block" data-hasbody="true" data-macro-name="tip"><div class="confluence-information-macro-body"><p class="auto-cursor-target"><strong>适用版本：<span style="color: rgb(255,0,0);">3.4.x、3.5.x、3.6.x</span></strong></p><p class="auto-cursor-target"><strong>关键词：告警、流量告警、微服务</strong></p></div></div><p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2" data-macro-name="toc"> </div></p><h2 id="id-如何为微服务设置流量告警-文档目的">文档目的</h2><p>目前，Service Mesh 平台已提供了<span style="color: rgb(0,0,0);">较为完整的微服务流量监控数据，若基于已有监控数据实现告警、通知，则可通过自动化运维帮助用户降低服务故障风险，提升服务运维效率。</span></p><p><span style="color: rgb(0,0,0);">本文将为您介绍，如何基于微服务流量监控数据配置告警、通知，实现微服务自动化运维。</span></p><h2 id="id-如何为微服务设置流量告警-方案概述">方案概述</h2><p><strong>提示</strong>：全栈云原生开放平台 v3.7.0 开始，已在产品功能支持微服务流量告警。</p><p>本方案基于 Service Mesh 平台的微服务流量监控指标（自定义表达式），结合容器平台或运维中心的告警、通知功能，为 Service Mesh 平台中微服务关联的 <strong>部署（Deployment）</strong>资源创建告警策略。当流量监控数据满足告警触发条件时，即可自动触发告警并发送通知，为您提供微服务自动化运维能力。</p><h2 id="id-如何为微服务设置流量告警-前提条件">前提条件</h2><p><span style="color: rgb(34,34,34);">微服务关联的部署所在的集群已部署了监控组件，且监控组件运行正常。</span></p><h2 id="id-如何为微服务设置流量告警-准备工作">准备工作</h2><ul><li>如需向指定用户发送微服务流量告警通知，请提前在平台的运维中心（需要平台管理相关权限）创建好通知策略。详细的操作步骤，请参考平台中心的 <strong>帮助文档</strong> &gt; <strong>用户手册 </strong>&gt;<strong> 运维中心 </strong>&gt;<strong> 通知 </strong>章节。</li><li>您登录平台的账号，至少需要拥有微服务所在命名空间的开发者相关权限；如需使用平台中心告警功能，您的账号需拥有平台管理相关权限。</li></ul><h2 id="id-如何为微服务设置流量告警-实现步骤">实现步骤</h2><p>本方案中的微服务流量告警策略可基于以下两种方式创建，请根据实际情况选择。</p><ul><li>（推荐）在 <strong>容器平台</strong> &gt; <strong>业务视图 </strong>&gt; <strong>告警 </strong>&gt; <strong>告警策略 </strong>功能页面，为微服务关联的部署创建告警策略。</li><li>在 <strong>运维中心 </strong>&gt; <strong>告警</strong> &gt; <strong>告警策略 </strong>功能页面，为微服务关联的部署创建告警策略。</li></ul><p>以下将以推荐方式为例，简要说明如何基于监控指标，为微服务关联的部署资源创建告警策略。详细操作步骤，请参考容器平台的 <strong>帮助文档</strong> &gt; <strong>用户手册 &gt; 运维中心 &gt;</strong><strong> 告警 </strong>章节。</p><p><strong>操作步骤</strong></p><ol><li>登录平台后，进入容器平台业务视图中微服务关联的部署所在的命名空间。</li><li>单击左侧导航栏中的<strong> 告警 </strong>&gt;<strong> 告警策略</strong>，进入告警策略列表页面。</li><li>单击 <strong>创建告警策略 </strong>按钮，进入告警策略创建页面。</li><li>参考以下说明，配置关键参数。 <br/><ul><li><strong>资源对象 </strong>选择与微服务关联的 <em><strong>部署</strong></em>。</li><li><strong>添加告警规则</strong>，并设置 <strong>告警规则 </strong>相关参数：<br/><ul><li><strong>告警类型</strong> 选择 <strong>自定义告警。</strong></li><li>参考 <a href="http://confluence.alauda.cn/pages/viewpage.action?pageId=91240377#id-%E5%A6%82%E4%BD%95%E4%B8%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E7%BD%AE%E6%B5%81%E9%87%8F%E5%91%8A%E8%AD%A6-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F" rel="nofollow">自定义表达式</a>，输入监控指标 <strong>表达式。提示：</strong>请根据实际数据替换变量值。</li><li>参考 <a href="http://confluence.alauda.cn/pages/viewpage.action?pageId=91240377#id-%E5%A6%82%E4%BD%95%E4%B8%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E7%BD%AE%E6%B5%81%E9%87%8F%E5%91%8A%E8%AD%A6-%E5%91%8A%E8%AD%A6%E6%8C%87%E6%A0%87%E8%AF%B4%E6%98%8E" rel="nofollow">告警指标参数</a>，设置 <strong>单位</strong>、<strong>触发条件。</strong><br/><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource confluence-content-image-border" height="330" width="450" src="http://confluence.alauda.cn/download/attachments/89074369/image2021-5-26_14-41-13.png?version=1&amp;modificationDate=1621982474000&amp;api=v2" data-image-src="http://confluence.alauda.cn/download/attachments/89074369/image2021-5-26_14-41-13.png?version=1&amp;modificationDate=1621982474000&amp;api=v2"></span></li></ul></li><li>（可选）选择运维中心已添加的 <strong>通知策略</strong>。</li></ul></li><li>单击<strong> 创建</strong><span>，</span>完成<span>告警策略的创建。<br/></span></li></ol><h2 id="id-如何为微服务设置流量告警-参考信息">参考信息</h2><h3 id="id-如何为微服务设置流量告警-自定义表达式">自定义表达式</h3><p><span style="color: rgb(23,43,77);">不同框架的微服务，设置告警时的自定义表达式不同，以下表达式分别适用于 </span><span style="color: rgb(23,43,77);">Service Mesh 服务和 Spring Cloud 服务。使用时，</span><span style="color: rgb(23,43,77);">请根据实际的微服务类型选择对应的表达式。</span></p><p><strong>说明</strong>：</p><ul><li>表达式中 [] 中内容为聚合时间，<span style="color: rgb(23,43,77);">可以根据实际情况修改，例如：[2m]。</span></li><li><p class="auto-cursor-target">表达式中 {} 中内容为变量，必须根据实际<span>情况修改，详细说明参见下表。<br/></span></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">变量</th><th class="confluenceTh">示例</th><th class="confluenceTh">说明</th></tr><tr><td class="confluenceTd">{namespace}</td><td class="confluenceTd">ns-01</td><td class="confluenceTd">命名空间名称</td></tr><tr><td class="confluenceTd">{workload}</td><td class="confluenceTd">deploy-01</td><td class="confluenceTd">计算组件名称</td></tr><tr><td class="confluenceTd">{tp-value}</td><td class="confluenceTd">0.50, 0.90, 0.95</td><td class="confluenceTd">TP 响应时间，分别对应 TP50、TP90、TP95</td></tr></tbody></table></div></li></ul><h4 id="id-如何为微服务设置流量告警-适用于ServiceMesh服务"><span>适用于 Service Mesh 服务</span></h4><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: csharp; gutter: true; theme: Django" data-theme="Django"># 传入请求数：
round(sum(increase(istio_requests_total{reporter=&quot;destination&quot;,destination_workload_namespace=&quot;{namespace}&quot;,destination_workload=&quot;{workload}&quot;} [1m])))
 
# 传入请求错误率：
round(sum(increase(istio_requests_total{reporter=&quot;destination&quot;,destination_workload_namespace=&quot;{namespace}&quot;,destination_workload=&quot;{workload}&quot;,response_code=~&quot;^[5|4]\\\\d\\\\d$&quot;} [1m]))) / round(sum(increase(istio_requests_total{reporter=&quot;destination&quot;,destination_workload_namespace=&quot;{namespace}&quot;,destination_workload=&quot;{workload}&quot;} [1m])))
 
# TP 响应时间：
histogram_quantile({tp-value}, sum(rate(istio_request_duration_milliseconds_bucket{reporter=&quot;destination&quot;,destination_workload_namespace=&quot;{namespace}&quot;,destination_workload=&quot;{workload}&quot;} [1m])) by (le))</pre>
</div></div><h4 id="id-如何为微服务设置流量告警-适用于SpringCloud服务">适用于 Spring Cloud 服务</h4><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: csharp; gutter: true; theme: Django" data-theme="Django"># 传入请求数：
round(sum(increase(http_server_requests_seconds_count{client_namespace!=&quot;unknown&quot;,namespace=&quot;{namespace}&quot;,service=&quot;{workload}&quot;} [1m])))
 
# 传入请求错误率：
round(sum(increase(http_server_requests_seconds_count{client_namespace!=&quot;unknown&quot;,namespace=&quot;{namespace}&quot;,service=&quot;{workload}&quot;,status=~&quot;^[5|4]\\\\d\\\\d$|CLIENT_ERROR|IO_ERROR&quot;} [1m]))) / round(sum(increase(http_server_requests_seconds_count{client_namespace!=&quot;unknown&quot;,namespace=&quot;{namespace}&quot;,service=&quot;{workload}&quot;} [1m])))
 
# TP 响应时间：
histogram_quantile({tp-value}, sum(rate(http_server_requests_seconds_bucket{client_namespace!=&quot;unknown&quot;,namespace=&quot;{namespace}&quot;,service=&quot;{workload}&quot;} [1m])) by (le)) * 1000</pre>
</div></div><h3 id="id-如何为微服务设置流量告警-告警指标说明">告警指标说明</h3><p><strong>注意</strong>：触发告警的持续时间需大于等于聚合时间。</p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 97.3149%;"><colgroup><col style="width: 7.95169%;"/><col style="width: 39.7418%;"/><col style="width: 21.3377%;"/><col style="width: 5.69728%;"/><col style="width: 8.537%;"/><col style="width: 8.53462%;"/><col style="width: 8.29074%;"/></colgroup><tbody><tr><th class="confluenceTh">指标</th><th colspan="1" class="confluenceTh">说明</th><th class="confluenceTh">指标数值要求</th><th class="confluenceTh">单位</th><th colspan="1" class="confluenceTh"><span style="color: rgb(23,43,77);">聚合时间(统计周期)</span></th><th colspan="1" class="confluenceTh">触发持续时间</th><th colspan="1" class="confluenceTh"><span style="color: rgb(23,43,77);">告警等级(告警频率)</span></th></tr><tr><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">TP50 响应时间</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">将某个时间段内请求按照响应时间从小到大排列，第 (请求总数*50%) 次请求的响应时间即为 TP50 响应时间。</span></td><td rowspan="3" style="text-align: left;" class="confluenceTd"><p><br/></p><ul><li><span style="color: rgb(23,43,77);">正数</span></li><li><span style="color: rgb(23,43,77);">整数部分 7 位</span></li><li><span style="color: rgb(23,43,77);">小数部分 2 位</span></li></ul></td><td rowspan="3" class="confluenceTd"><p><br/></p><p><br/></p><p>毫秒（ms）<br/><br/></p></td><td rowspan="5" class="confluenceTd"><p><br/></p><p><br/></p><p><br/></p><p><span style="color: rgb(23,43,77);">1分钟...、30分钟</span></p></td><td rowspan="5" class="confluenceTd"><p><br/></p><p><br/></p><p><br/></p><p>1-10 个周期</p></td><td rowspan="5" class="confluenceTd"><p><br/></p><p><br/></p><p><br/></p><ul><li><span style="color: rgb(23,43,77);">灾难</span></li><li><span style="color: rgb(23,43,77);">严重</span></li><li><span style="color: rgb(23,43,77);">警告</span></li><li><span style="color: rgb(23,43,77);">提示</span></li></ul></td></tr><tr><td class="confluenceTd"><span style="color: rgb(23,43,77);">TP90 响应时间</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">将某个时间段内请求按照响应时间从小到大排列，第 (请求总数*90%) 次请求的响应时间即为 TP90 响应时间。</span></td></tr><tr><td class="confluenceTd"><span style="color: rgb(23,43,77);">TP95 响应时间</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">将某个时间段内请求按照响应时间从小到大排列，第 (请求总数*95%) 次请求的响应时间即为 TP95 响应时间。</span></td></tr><tr><td class="confluenceTd"><span style="color: rgb(23,43,77);">传入请求数</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">服务作为被调方接收请求，处理的请求总数。</span></td><td class="confluenceTd"><ul><li><span style="color: rgb(23,43,77);">正整数</span></li><li><span style="color: rgb(23,43,77);">整数部分 17 位</span></li></ul></td><td class="confluenceTd">个</td></tr><tr><td class="confluenceTd"><span style="color: rgb(23,43,77);">传入请求错误率</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(23,43,77);">服务作为被调方接收请求，一段持续的时间段内，错误请求数占时间段内请求数的比率。</span></td><td class="confluenceTd"><ul><li><span style="color: rgb(23,43,77);">正数</span></li><li><span style="color: rgb(23,43,77);">整数部分 7 位</span></li><li><span style="color: rgb(23,43,77);">小数部分 2 位</span></li></ul></td><td class="confluenceTd"><p>%</p></td></tr></tbody></table></div>